server {
	server_name keyserver.vsund.de
	            keyserver.valentin-sundermann.de;

	include snippets/misc/listen-80.conf; # ipv{4,6} + http
	include snippets/hardening/headers.conf;
	include snippets/misc/acme.conf;

	access_log /var/log/nginx/keyserver/access.log anonymized;
	error_log /dev/null;

	location / {
		return 301 https://$server_name$request_uri;
	}
}

server {
	server_name keyserver.vsund.de
	            keyserver.valentin-sundermann.de
	            sfuulriypdms4mnl.onion;
	server_name *.sks-keyservers.net
	            *.pool.sks-keyservers.net
	            keys.gnupg.net
	            pgp.ipfire.org;

	include snippets/misc/listen-443.conf; # ipv{4,6} + https
	listen 127.0.0.1:80; # tor onion service

	# Reverse proxy for local sks instance
	listen 11371;
	listen [::]:11371;

	access_log /var/log/nginx/keyserver/access.log anonymized;
	error_log /dev/null;

	include snippets/tls/tls-vsund-keyserver.conf;
	include snippets/hardening/headers-tls.conf;
	include snippets/rewrites/no-www.conf;
	include snippets/misc/custom-errorpages.conf;

	root /data/www/keyserver/public_html;

	rewrite ^/stats /pks/lookup?op=stats;
	rewrite ^/s/(.*) /pks/lookup?search=$1;
	rewrite ^/search/(.*) /pks/lookup?search=$1;
	rewrite ^/g/(.*) /pks/lookup?op=get&search=$1;
	rewrite ^/get/(.*) /pks/lookup?op=get&search=$1;
	rewrite ^/d/(.*) /pks/lookup?op=get&options=mr&search=$1;
	rewrite ^/download/(.*) /pks/lookup?op=get&options=mr&search=$1;

	location /pks {
		proxy_pass http://127.0.0.1:21371;
		proxy_pass_header Server;
		add_header Via "1.1 keyserver.vsund.de:11371 (nginx)";
		proxy_ignore_client_abort on;
		client_max_body_size 8m;
	}

	location /static {
		add_header Access-Control-Allow-Origin "*";
	}

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

        include snippets/cache/static.conf;

	include snippets/hardening/denied-locations.conf;
}
